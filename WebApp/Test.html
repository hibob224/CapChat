<!DOCTYPE HTML>
<html>
	<head>
        <style>
            #textSpan{
                font-size:20px;
                font-family:MomsTypewriter;
                visibility:hidden;
                height:auto;
                width:auto;
                white-space:nowrap
            }
        </style>
		<title>CaptChat</title>
		<script type="text/javascript" src='http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js'></script>
		<script type="text/javascript" src='scripts/Font.js'></script>
		<script type="text/javascript">
			$((function() {
				//Preloads font
				CaptChat.tCtx   = document.getElementById('textCanvas').getContext('2d');
				var font        = new Font();
				font.src        = "Fonts/moms.ttf";
				font.fontFamily = "MomsTypewriter";
				//Displays 'First' Captcha once font is ready
				font.onload = function () {
					CaptChat.captchaIfy("onLoad");
				}

            }));
            CaptChat = {
				tCtx: {}, //Canvas context will be assigned here on page load
                fontSize: "20px",
				runScript: function(e) {
					if (e.keyCode == 13 && document.getElementById('input').value) {
                        CaptChat.doTheThing();
                        document.getElementById('input').value = '';
					}
				},

                doTheThing: function(input) {
                    input = input || document.getElementById('input').value;
                    input = input.trim().replace(/\s+/g, ' ').split(' ');
                    for( var word in input ){
                        CaptChat.canvas.width(CaptChat.textWdith(input[word])+10);
                        CaptChat.captchaIfy(input[word]);
                        CaptChat.appendImg(CaptChat.canvas.toImg());
                        CaptChat.canvas.clear();
                    }

                },

				captchaIfy: function(input) {
					CaptChat.tCtx.font = "normal "+ CaptChat.fontSize +" MomsTypewriter"; //Set text fonts option for  canvas,html5 canvas: Text Option
					CaptChat.tCtx.strokeStyle = "#000000";				                  //HTML5 canvas: Text Option
					CaptChat.canvas.clear();                                              //Clear previous Canvas for redraw our captcha
					CaptChat.tCtx.strokeText(input,0,20,CaptChat.canvas.width());		  //Stroke random string to canvas
					CaptChat.tCtx.textBaseline = "middle";				                  //HTML5 canvas: Text Option,line in middle of text
				},

                canvas: {
                    /*****THERE IS BASICALLY NO TYPE CHECKING, ONLY SEND ACTUAL WIDTH/HEIGHT VALUES KTHX*****/
                    //width() returns width, width(width) sets width then returns confirmation
                    width: function(width) {
                        if( arguments.length ){
                            document.getElementById('textCanvas').width = width;
                        }
                        return document.getElementById('textCanvas').width;
                    },

                    //height() returns height, height(height) sets height then returns confirmation
                    height: function(height) {
                        if( arguments.length ){
                            document.getElementById('textCanvas').height = height;
                        }
                        return document.getElementById('textCanvas').height;
                    },

                    clear: function(tCtx) {
                        tCtx = tCtx || CaptChat.tCtx;
                        tCtx.clearRect(0,0,CaptChat.canvas.width(),CaptChat.canvas.height());
                    },

                    toDataURL: function(tCtx) {
                        tCtx = tCtx || CaptChat.tCtx;
                        return tCtx.canvas.toDataURL;
                    },

                    toImg: function(tCtx) {
                        tCtx = tCtx || CaptChat.tCtx;
                        var	imageElem = document.createElement('img');
                        imageElem.src = tCtx.canvas.toDataURL();

                        return imageElem;
                    },
                },
                // Returns actual pixel width of @param:text or everything inside #input if nothing passed
                textWdith : function(text) {
                    text = text || document.getElementById('input').value;
                    var textSpan = document.getElementById('textSpan');
                    textSpan.style.fontSize = CaptChat.fontSize; //Makes sure we're measuring the right font size
                    textSpan.innerHTML = text;
                    console.log($(textSpan).width())
                    return $(textSpan).width();
                },

				appendImg: function(img) {
					var messages = document.getElementById('messages');
					messages.appendChild(img);
				},
			};
		</script>
	</head>

	<body>
		<div>
			<ul id='messages' >
			</ul>
			<canvas id='textCanvas' width=150 height=30></canvas>
			<br>
		  	<input id="input" type=text onkeypress="CaptChat.runScript(event)">
            <span id="textSpan">onLoad</span>
		</div>
	</body>
</html>
